![Build Status](https://img.shields.io/github/workflow/status/jegan42/jcg_calendly/CI?style=flat-square)

# üóìÔ∏è Calendly Backend

Backend Node.js/Express pour une app type Calendly, avec :

-   Authentification Google via Passport
-   JWT s√©curis√© via cookie
-   Base de donn√©es g√©r√©e par Supabase
-   Environnement pr√™t pour production (Render)

---

## üöÄ Stack utilis√©e

-   **[Node.js](https://nodejs.org/en/)** (version 22.14.0) : Serveur backend pour g√©rer les requ√™tes HTTP.
-   **[Express](https://expressjs.com/)** (version 5.1.0) : Framework pour la gestion des routes et middlewares.
-   **[Supabase](https://supabase.com/)** : Plateforme de backend-as-a-service pour g√©rer l'authentification, les fonctions serverless et la base de donn√©es (PostgreSQL).
-   **[Prisma ORM](https://www.prisma.io/)** : Outil pour interagir avec la base de donn√©es et g√©rer les mod√®les.
-   **[JWT (JSON Web Tokens)](https://jwt.io/)** : Utilis√© pour l'authentification et l'autorisation des utilisateurs.
-   **[Google OAuth2](https://developers.google.com/identity/protocols/oauth2)** : Strat√©gie d'authentification via Google.
-   **[Passport.js](http://www.passportjs.org/)** : Middleware pour l'authentification via diff√©rentes strat√©gies (incluant Google OAuth).
-   **[Node-cron](https://www.npmjs.com/package/node-cron)** : Utilis√© pour ex√©cuter des t√¢ches r√©currentes c√¥t√© serveur (ex. rappels programm√©s).
-   **[Helmet](https://helmetjs.github.io/)** : Middleware de s√©curit√© pour Express, prot√©geant contre les vuln√©rabilit√©s courantes.
-   **[cookie-parser](https://www.npmjs.com/package/cookie-parser)** et **[express-session](https://www.npmjs.com/package/express-session)** : Gestion des sessions et des cookies dans l'application.
-   **[csrf-tokens](https://www.npmjs.com/package/csrf-tokens)** et **[csurf](https://www.npmjs.com/package/csurf)** : Protection contre les attaques Cross-Site Request Forgery (CSRF).
-   **[TypeScript](https://www.typescriptlang.org/)** : Langage de programmation utilis√© pour ce projet, offrant un typage statique pour une meilleure maintenance du code.
-   **[nodemon](https://www.npmjs.com/package/nodemon)** et **[ts-node-dev](https://www.npmjs.com/package/ts-node-dev)** : Outils pour le d√©veloppement en temps r√©el et le red√©marrage automatique du serveur.
-   **[Render](https://render.com/)** : Plateforme de d√©ploiement cloud offrant des services pour h√©berger des applications web, des bases de donn√©es, et des fonctions serverless. Elle permet un d√©ploiement rapide et facile avec une gestion automatique des ressources et des mises √† jour.

---

## üöÄ Installation

### Pr√©requis

Avant de commencer, assurez-vous d'avoir install√© les outils suivants :

-   [Node.js](https://nodejs.org) (version utilis√© pour ce projet 22.14.0)
-   [npm](https://www.npmjs.com/)
-   [Supabase](https://supabase.com/) Compte Supabase pour la gestion de la base de donn√©es et des fonctionnalit√©s back-end (authentification, stockage, etc.)

### √âtapes d'installation

1. Clonez le repository :
    ```bash
    git clone https://github.com/jegan42/jcg_calendly.git
    ```
2. Allez dans le dossier du projet :
    ```bash
    cd jcg_calendly
    ```
3. Installez les d√©pendances :
    - Avec npm :
        ```bash
        npm install
        ```
    - Avec yarn :
        ```bash
        yarn install
        ```
4. Cr√©ez un fichier `.env` √† la racine du projet et configurez les variables d'environnement suivantes :
   `    PORT=5000
    CLIENT_URL=http://localhost:3000
    DATABASE_URL=postgresql://user:password@localhost:5432/dbname
    GOOGLE_CLIENT_ID=your-google-client-id
    GOOGLE_CLIENT_SECRET=your-google-client-secret
    JWT_SECRET=your-jwt-secret
   `
   ‚ö†Ô∏è Note de s√©curit√© : Ne partagez jamais vos cl√©s d'API (`SUPABASE_SERVICE_KEY`, `GOOGLE_CLIENT_ID`, `JWT_SECRET`, etc.) publiquement. Gardez-les dans un environnement s√©curis√©.

5. Lancez le projet en mode d√©veloppement :
    ```bash
    npm run dev
    ```
    ou, si vous utilisez Yarn :
    ```bash
    yarn dev
    ```

Le serveur sera accessible √† l'adresse `http://localhost:5000`.

---

## ‚öôÔ∏è Configuration

### Google OAuth

1. Cr√©e un projet sur [Google Cloud Console](https://console.cloud.google.com/).
2. Active l'API Google OAuth 2.0.
3. G√©n√®re un `GOOGLE_CLIENT_ID` et `GOOGLE_CLIENT_SECRET` dans la section "Identifiants" du projet

### Supabase

1. Cr√©e un projet sur [Supabase](https://supabase.com).
2. R√©cup√®re l'URL de ton projet Supabase (supabase_url) et la cl√© de service (SUPABASE_SERVICE_KEY) depuis la section API de ton projet.

---

## üìÅ Structure du projet

-   `back/` - Dossier principal contenant tout le code du backend.
    -   `src/` - Contient les fichiers source du projet backend.
        -   `controllers/` - Contient les logiques des contr√¥leurs pour la gestion des requ√™tes.
        -   `lib/` - Biblioth√®ques et utilitaires sp√©cifiques au projet.
        -   `middleware/` - Contient les middlewares pour la gestion des s√©curit√©s, authentifications, etc.
        -   `routes/` - D√©finition des routes de l'API.
        -   `services/` - Logique m√©tier, par exemple, pour la gestion des √©v√©nements.
        -   `supabase/` - Contient la configuration sp√©cifique √† Supabase.
        -   `types/` - D√©finition des types TypeScript pour garantir la s√©curit√© du typage.
        -   `tsconfig.json` - Fichier de configuration de TypeScript.
        -   `package.json` - Liste des d√©pendances et des scripts npm.

---

## üß™ Routes utiles

| Route                                   | M√©thode HTTP | Description                                                    | Middleware                        |
| --------------------------------------- | ------------ | -------------------------------------------------------------- | --------------------------------- |
| `/`                                     | `GET`        | V√©rification de l'√©tat de l'application (health check)         | -                                 |
| `/auth/google`                          | `GET`        | Redirection pour l'authentification via Google                 | `passport.authenticate("google")` |
| `/auth/google/callback`                 | `GET`        | Callback apr√®s l'authentification via Google                   | `passport.authenticate("google")` |
| `/auth/me`                              | `GET`        | R√©cup√®re les donn√©es de l'utilisateur connect√©                 | `requireJWTAuth`                  |
| `/auth/logout`                          | `GET`        | D√©connexion (suppression du cookie JWT)                        | -                                 |
| `/events`                               | `POST`       | Cr√©ation d'un √©v√©nement                                        | `requireJWTAuth`, `validateEvent` |
| `/events`                               | `GET`        | R√©cup√®re tous les √©v√©nements de l'utilisateur connect√©         | `requireJWTAuth`                  |
| `/events/:id`                           | `GET`        | R√©cup√®re un √©v√©nement sp√©cifique par ID                        | `requireJWTAuth`                  |
| `/events/:id`                           | `PUT`        | Mise √† jour d'un √©v√©nement sp√©cifique par ID                   | `requireJWTAuth`                  |
| `/events/:id`                           | `DELETE`     | Suppression d'un √©v√©nement sp√©cifique par ID                   | `requireJWTAuth`                  |
| `/events/check-availability`            | `POST`       | V√©rifie la disponibilit√© d'un cr√©neau horaire                  | `requireJWTAuth`                  |
| `/events/book/:slug`                    | `GET`        | R√©cup√®re les d√©tails d'un type d'√©v√©nement par "slug" (public) | -                                 |
| `/notification/send-event-notification` | `POST`       | Envoi d'une notification de confirmation d'√©v√©nement           | `requireJWTAuth`                  |
| `/notification/send-event-reminder`     | `POST`       | Envoi d'un rappel pour un √©v√©nement                            | `requireJWTAuth`                  |

---

## üîê Authentification

L‚Äôapp utilise Google OAuth 2.0 :

-   `/auth/google` ‚Üí d√©marre le login Google

-   `/auth/google/callback` ‚Üí callback apr√®s login

-   Cookie JWT s√©curis√© pour maintenir la session

Middleware :

-   `requireJWTAuth` prot√®ge les routes comme `/dashboard`, `/user/me`, etc.

---

## ‚öôÔ∏è Fonctionnalit√©s suppl√©mentaires

### üïí Rappels d'√©v√©nements (Automatiques via Cron)

Les rappels d'√©v√©nements sont envoy√©s automatiquement en arri√®re-plan gr√¢ce √† un cron job. Ce processus est g√©r√© par la fonction `scheduleEventReminders`, qui s'ex√©cute toutes les minutes et v√©rifie les √©v√©nements pr√©vus pour les 1 heure et 24 heures √† venir.

-   **Comment √ßa marche ?**

    -   √Ä chaque ex√©cution, la fonction r√©cup√®re les √©v√©nements qui doivent avoir lieu dans les 1h ou 24h.
    -   Ensuite, elle envoie des emails de rappel aux invit√©s et √† l'organisateur de l'√©v√©nement.

-   **Comment v√©rifier que le cron job fonctionne ?**
    -   Vous pouvez v√©rifier les logs des t√¢ches cron pour toute activit√© d'ex√©cution en arri√®re-plan.
    -   Assurez-vous qu'un √©v√©nement de test avec un rappel pr√©vu dans l'heure suivante est correctement rappel√© par email.

Cette fonctionnalit√© fonctionne automatiquement en arri√®re-plan et n'est pas accessible via une route API, mais elle garantit que les utilisateurs re√ßoivent des rappels en temps voulu pour leurs √©v√©nements.

### üìÖ Gestion des √©v√©nements

Ce projet permet aux utilisateurs de cr√©er et de g√©rer leurs √©v√©nements via une interface API RESTful. Les utilisateurs peuvent :

-   Cr√©er un √©v√©nement avec des d√©tails (titre, date, etc.).
-   Mettre √† jour ou supprimer des √©v√©nements.
-   V√©rifier la disponibilit√© d'un cr√©neau horaire pour planifier un √©v√©nement.

Les √©v√©nements sont stock√©s dans Supabase, qui offre une base de donn√©es PostgreSQL g√©r√©e avec une authentification int√©gr√©e.

---

## üõ† D√©ploiement sur Render

üü¢ Pr√™t pour le d√©ploiement sur Render.

Suivez les √©tapes ci-dessous pour d√©ployer ce projet sur [Render](https://render.com) :

1. Cr√©e un compte sur [Render](https://render.com).
2. Cr√©e un nouveau service de type **Node.js**.
3. D√©finis le r√©pertoire racine comme `back`.
4. Utilise les commandes suivantes pour le d√©ploiement :

    - **Build Command** : `npm install && npm run build`
    - **Start Command** : `npm run start`

5. N'oublie pas de configurer les **variables d'environnement** dans l'interface de Render pour la connexion √† Supabase et Google OAuth.

Exemple de variables √† configurer :

```env
SUPABASE_URL=...
SUPABASE_SERVICE_KEY=...
GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...
JWT_SECRET=...
CLIENT_URL=https://tonfrontend.vercel.app
NODE_ENV=production
```

‚ö†Ô∏è Rappel : ne partage pas tes cl√©s API publiquement, et assure-toi qu'elles sont d√©finies dans les variables d'environnement lors du d√©ploiement.

---

## üõ† Gestion des erreurs

Actuellement, la gestion des erreurs est basique, mais nous pr√©voyons d'ajouter une gestion centralis√©e des erreurs avec des logs et une meilleure gestion des r√©ponses d'erreur.

**Prochaines √©tapes** :

-   Impl√©mentation d'un middleware de gestion des erreurs.
-   Envoi de notifications ou d'alertes en cas d'erreurs critiques.
-   Am√©lioration de la gestion des erreurs pour les routes API.

Actuellement, les erreurs sont renvoy√©es directement au client, mais cela sera am√©lior√© dans une future mise √† jour.

---

## üß™ Tests unitaires

Les tests unitaires seront ajout√©s plus tard pour garantir la stabilit√© et la fiabilit√© du backend. En attendant, il est conseill√© de tester les diff√©rentes routes manuellement.

Pour ex√©cuter les tests (si configur√©s dans le futur), vous pouvez utiliser la commande suivante :

```bash
npm run test
```

---

## ‚úÖ √Ä faire

Auth Google + JWT (OK)

Cookie s√©curis√© (OK)

Middleware prot√©g√© (OK)

Int√©gration avec le frontend (plus tard)

Tests unitaires (plus tard)

Gestion des erreurs (am√©liorer la gestion des erreurs globales)

---

## ü§ù Contribuer

Si vous souhaitez contribuer √† ce projet, voici les √©tapes √† suivre :

1. Fork ce repository.
2. Cr√©ez une branche (`git checkout -b feature/nouvelle-fonctionnalit√©`).
3. Faites vos changements et ajoutez des tests (si applicable).
4. Soumettez vos changements (`git commit -am 'Ajout d\'une nouvelle fonctionnalit√©'`).
5. Poussez la branche (`git push origin feature/nouvelle-fonctionnalit√©`).
6. Ouvrez une pull request.

Merci de vous conformer aux [guidelines de style de code](#) pour assurer une bonne int√©gration dans le projet.

---

## ‚ö†Ô∏è Erreurs courantes

-   **Erreur : "Port d√©j√† utilis√©"**  
    Cette erreur se produit lorsque le port `5000` est d√©j√† utilis√© par un autre processus. Vous pouvez changer le port en modifiant la variable d'environnement `PORT` dans votre fichier `.env`.

-   **Erreur : "Erreur d'authentification Google"**  
    Si vous obtenez une erreur li√©e √† Google OAuth, assurez-vous que vos cl√©s API Google sont correctes et que votre projet Google Cloud est correctement configur√© pour accepter les connexions.

---

üì¨ Contact
Made with ‚ù§Ô∏è by jegan42 >> https://github.com/jegan42
